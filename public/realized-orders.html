<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zamówienia Zrealizowane - Sklep z Aromatami</title>
    <link rel="stylesheet" href="style.css">
    <script>
        const username = localStorage.getItem('username');
        if (username !== 'MKL') {
            window.location.href = 'login.html';
        }
    </script>
</head>
<body>
    <header>
        <div class="logo">Panel Administratora - Sklep z Aromatami</div>
        <nav>
            <ul>
                <li><a href="admin.html">Zamówienia</a></li>
                <li><a href="realized-orders.html">Zamówienia Zrealizowane</a></li>
                <li><a href="paid-orders.html">Zamówienia Opłacone</a></li>
                <li><a href="login.html" id="logout-button">Wyloguj</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="realized-orders">
            <h2>Zamówienia Zrealizowane</h2>
            <div id="user-list"></div> <!-- Lista użytkowników -->
            <div id="order-details" style="display: none;">
                <h3> Szczegóły zamówienia dla użytkownika <span id="customer-name"></span></h3>
                <div id="order-list"></div> <!-- Szczegóły zamówienia -->
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 Sklep z Aromatami. Wszystkie prawa zastrzeżone.</p>
    </footer>

    <script>
        // Funkcja pobierająca zamówienia zrealizowane z bazy danych
        function fetchRealizedOrders() {
            fetch('https://kuciapki.onrender.com/realized-orders', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Błąd podczas pobierania zamówień zrealizowanych');
                }
                return response.json();
            })
            .then(realizedOrders => {
                console.log('Zrealizowane zamówienia:', realizedOrders); // Logowanie danych
                displayRealizedOrders(realizedOrders);
            })
            .catch(error => {
                console.error('Błąd podczas pobierania zamówień zrealizowanych:', error);
            });
        }

        // Wyświetlanie listy użytkowników z zamówieniami
        function displayRealizedOrders(realizedOrders) {
            const userList = document.getElementById('user-list');
            const orderDetailsSection = document.getElementById('order-details');
            const customerNameElement = document.getElementById('customer-name');
            const orderList = document.getElementById('order-list');
            let currentlyVisibleOrderIndex = null;

            userList.innerHTML = '';

            realizedOrders.forEach((order, index) => {
                const userItem = document.createElement('div');
                userItem.innerHTML = `<p><a href="#" data-id="${order._id}" data-index="${index}" class="order-link">${order.customerName}</a></p>`;
                userList.appendChild(userItem);
            });

            userList.addEventListener('click', function(event) {
                if (event.target.classList.contains('order-link')) {
                    event.preventDefault();
                    const orderIndex = event.target.getAttribute('data-index');

                    if (currentlyVisibleOrderIndex === orderIndex) {
                        orderDetailsSection.style.display = 'none';
                        currentlyVisibleOrderIndex = null;
                    } else {
                        const selectedOrder = realizedOrders[orderIndex];
                        customerNameElement.textContent = selectedOrder.customerName;
                        orderList.innerHTML = '';

                        selectedOrder.items.forEach(item => {
                            const orderItem = document.createElement('div');
                            orderItem.innerHTML = `<p>${item.name} - ilość: ${item.quantity}</p>`;
                            orderList.appendChild(orderItem);
                        });

                        const markAsPaidButton = document.createElement('button');
                        markAsPaidButton.textContent = 'Oznacz jako opłacone';
                        markAsPaidButton.onclick = function() {
                            markOrderAsPaid(selectedOrder._id);
                        };
                        orderList.appendChild(markAsPaidButton);

                        orderDetailsSection.style.display = 'block';
                        currentlyVisibleOrderIndex = orderIndex;
                    }
                }
            });
        }

        // Funkcja oznaczająca zamówienie jako opłacone
        function markOrderAsPaid(orderId) {
            fetch(`https://kuciapki.onrender.com/orders/${orderId}/pay`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(() => {
                alert('Zamówienie zostało oznaczone jako opłacone');
                window.location.reload();
            })
            .catch(error => {
                console.error('Błąd podczas oznaczania zamówienia jako opłacone:', error);
            });
        }

        // Pobieranie zamówień po załadowaniu strony
        fetchRealizedOrders();
    </script>
</body>
</html>
